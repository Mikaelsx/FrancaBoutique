<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>ColorShop - Login</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link rel="stylesheet" href="reset.css">
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{--bg:#fff;--text:#000;--gray:#666;--border:#e5e5e5;--light:#f9fafb;--error:#ef4444;--success:#16a34a;--whatsapp:#25d366}
body{font-family:Inter,sans-serif;background:var(--bg);color:var(--text);min-height:100vh;overflow-x:hidden}
.container{display:flex;min-height:100vh}
.left-side{flex:1;background:linear-gradient(135deg,rgba(0,0,0,.7),rgba(0,0,0,.4)),url('./assets/Background.svg')center/cover;display:flex;flex-direction:column;justify-content:center;align-items:center;padding:60px;color:#fff;position:relative;overflow:hidden}
.left-side::before{content:'';position:absolute;inset:0;background:radial-gradient(circle at 30% 50%,rgba(255,255,255,.1),transparent 60%);pointer-events:none}
.features{display:grid;gap:24px;max-width:640px;width: 400px; margin:0 auto;z-index:1}
.feature{display:flex;align-items:center;gap:16px;background:rgba(255,255,255,.1);backdrop-filter:blur(10px);padding:16px 24px;border-radius:12px;border:1px solid rgba(255,255,255,.2);transition:all .3s}
.feature:hover{background:rgba(255,255,255,.15);transform:translateX(5px)}
.feature-icon{width:48px;height:48px;min-width:48px;background:rgba(255,255,255,.2);border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:22px}
.feature-text h4{font-size:16px;font-weight:700;margin-bottom:4px}
.feature-text p{font-size:14px;opacity:.8}
.right-side{flex:1;display:flex;align-items:center;justify-content:center;padding:60px;background:var(--bg)}
.form-container{width:100%;max-width:480px}
.form-header{margin-bottom:40px}
.form-title{font-size:40px;font-weight:900;letter-spacing:-2px;margin-bottom:12px}
.form-subtitle{font-size:15px;color:var(--gray);font-weight:600}
.tabs{display:flex;margin-bottom:32px;border:1px solid var(--border);border-radius:12px;overflow:hidden;background:var(--light)}
.tab{flex:1;padding:16px 28px;border:none;background:transparent;color:var(--gray);font-size:13px;font-weight:700;letter-spacing:.5px;text-transform:uppercase;cursor:pointer;transition:all .3s;font-family:inherit;border-right:1px solid var(--border)}
.tab:last-child{border-right:none}
.tab.active{background:var(--text);color:#fff}
.tab:hover:not(.active){background:var(--bg);color:var(--text)}
.panel{display:none}
.panel.active{display:block;animation:fadeIn .4s}
@keyframes fadeIn{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
.form-group{margin-bottom:20px}
.label{display:block;font-size:13px;font-weight:700;letter-spacing:.5px;text-transform:uppercase;margin-bottom:8px}
.input{width:100%;padding:14px 16px;border:1px solid var(--border);border-radius:12px;font-size:15px;font-family:inherit;background:var(--light);transition:all .3s;font-weight:500}
.input:focus{outline:none;border-color:var(--text);background:var(--bg);box-shadow:0 0 0 3px rgba(0,0,0,.05)}
.input::placeholder{color:#d4d4d4}
.input-group{position:relative}
.input-icon{position:absolute;right:16px;top:50%;transform:translateY(-50%);color:var(--gray);cursor:pointer;transition:all .3s;font-size:16px}
.input-icon:hover{color:var(--text)}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.checkbox-group{display:flex;align-items:center;gap:8px;margin-bottom:24px}
.checkbox-group input{width:18px;height:18px;cursor:pointer;accent-color:var(--text)}
.checkbox-group label{font-size:14px;color:var(--gray);cursor:pointer;font-weight:600}
.checkbox-group a{color:var(--text);text-decoration:none;font-weight:700;margin-left:auto;display:flex;align-items:center;gap:6px}
.checkbox-group a:hover{text-decoration:underline}
.btn{width:100%;padding:16px 32px;border:none;border-radius:50px;font-size:13px;font-weight:700;cursor:pointer;transition:all .3s;font-family:inherit;display:flex;align-items:center;justify-content:center;gap:10px;letter-spacing:.5px;text-transform:uppercase;background: rgb(201, 20, 20);color:#fff}
.btn:hover:not(:disabled){transform:translateY(-3px);box-shadow:0 12px 32px rgba(0,0,0,.15)}
.btn:disabled{opacity:.5;cursor:not-allowed}
.btn-outline{background:transparent;color:var(--text);border:2px solid var(--border)}
.btn-outline:hover:not(:disabled){background:var(--text);color:#fff;border-color:var(--text)}
.divider{display:flex;align-items:center;gap:16px;margin:32px 0;color:var(--gray);font-size:12px;text-transform:uppercase;letter-spacing:1px;font-weight:700}
.divider::before,.divider::after{content:'';flex:1;height:1px;background:var(--border)}
.social-btns{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.btn-social{padding:12px 20px;border:2px solid var(--border);border-radius:50px;background:var(--bg);color:var(--text);font-size:13px;font-weight:700;cursor:pointer;transition:all .3s;font-family:inherit;display:flex;align-items:center;justify-content:center;gap:8px}
.btn-social:hover:not(:disabled){background:var(--light);border-color:var(--text);transform:translateY(-2px)}
.btn-social:disabled{opacity:.5;cursor:not-allowed}
.alert{padding:12px 16px;margin-bottom:24px;border:1px solid;border-radius:12px;font-size:14px;font-weight:600;display:none}
.alert.show{display:block;animation:slideDown .4s}
@keyframes slideDown{from{opacity:0;transform:translateY(-20px)}to{opacity:1;transform:translateY(0)}}
.alert-error{background:rgba(239,68,68,.1);border-color:var(--error);color:#991b1b}
.alert-success{background:rgba(22,163,74,.1);border-color:var(--success);color:#065f46}
.spinner{display:inline-block;width:16px;height:16px;border:2px solid rgba(255,255,255,.3);border-top-color:#fff;border-radius:50%;animation:spin .6s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:10000;align-items:center;justify-content:center;padding:20px;backdrop-filter:blur(5px)}
.modal.active{display:flex;animation:fadeIn .3s}
.modal-box{background:var(--bg);border:1px solid var(--border);border-radius:0px;padding:40px;max-width:600px;width:100%;box-shadow:0 20px 60px rgba(0,0,0,.2);animation:modalUp .4s;position:relative}
@keyframes modalUp{from{opacity:0;transform:translateY(30px)}to{opacity:1;transform:translateY(0)}}
.modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:24px}
.modal-title{font-size:24px;font-weight:900;letter-spacing:-1px}
.modal-close{background:none;border:none;font-size:24px;cursor:pointer;color:var(--gray);padding:0;width:32px;height:32px;display:flex;align-items:center;justify-content:center;border-radius:50%;transition:all .3s}
.modal-close:hover{background:var(--light);color:var(--text)}
.modal-icon{width:80px;height:80px;background:var(--whatsapp);color:#fff;display:flex;align-items:center;justify-content:center;font-size:36px;margin:0 auto 24px;border-radius:50%;box-shadow:0 8px 24px rgba(37,211,102,.3)}
.modal-desc{font-size:15px;color:var(--gray);line-height:1.6;margin-bottom:28px;text-align:center}
.whatsapp-info{background:rgba(37,211,102,.1);border:1px solid rgba(37,211,102,.3);border-radius:12px;padding:16px;margin-bottom:24px;font-size:14px;color:#065f46;line-height:1.6;text-align:center}
.whatsapp-info strong{display:block;margin-bottom:8px;font-size:15px}
.logged-screen{text-align:center;animation:fadeIn .4s}
.logged-screen .icon{width:100px;height:100px;background:linear-gradient(135deg,var(--success),#0d9488);color:#fff;display:flex;align-items:center;justify-content:center;font-size:48px;margin:0 auto 32px;border-radius:50%;box-shadow:0 12px 40px rgba(22,163,74,.3)}
.logged-screen h2{font-size:32px;font-weight:900;letter-spacing:-1px;margin-bottom:16px}
.logged-screen p{font-size:16px;color:var(--gray);margin-bottom:32px;line-height:1.6}
.logged-screen .user-info{background:var(--light);border:1px solid var(--border);border-radius:16px;padding:24px;margin-bottom:32px;text-align:left}
.logged-screen .user-info div{display:flex;justify-content:space-between;align-items:center;padding:12px 0}
.logged-screen .user-info div:not(:last-child){border-bottom:1px solid var(--border)}
.logged-screen .user-info strong{font-size:12px;text-transform:uppercase;letter-spacing:.5px;color:var(--gray);font-weight:700}
.logged-screen .user-info span{font-size:15px;font-weight:600}
.btn-group{display:grid;gap:12px}
@media(max-width:1024px){
.container{flex-direction:column}
.left-side{min-height:40vh;padding:40px 24px}
.features{grid-template-columns:1fr}
.right-side{padding:40px 24px}
.form-title{font-size:32px}
.form-row{grid-template-columns:1fr}
.social-btns{grid-template-columns:1fr}
}
@media(max-width:768px){
.left-side{min-height:30vh;padding:32px 20px}
.features{display:none}
.right-side{padding:32px 20px}
.form-title{font-size:28px}
.modal-box{padding:32px 24px}
}
</style>
</head>
<body>

<div class="container">
<!-- Left Side -->
<div class="left-side">
<div class="features">
<div class="feature">
<div class="feature-icon"><i class="fas fa-shield-halved"></i></div>
<div class="feature-text">
<h4>Segurança Total</h4>
<p>Seus dados protegidos</p>
</div>
</div>
<div class="feature">
<div class="feature-icon"><i class="fas fa-truck-fast"></i></div>
<div class="feature-text">
<h4>Entrega Rápida</h4>
<p>Receba em casa</p>
</div>
</div>
<div class="feature">
<div class="feature-icon"><i class="fas fa-star"></i></div>
<div class="feature-text">
<h4>Qualidade Premium</h4>
<p>Produtos selecionados</p>
</div>
</div>
</div>
</div>

<!-- Right Side -->
<div class="right-side">
<div class="form-container">
<!-- Logged Screen -->
<div id="loggedScreen" style="display:none">
<div class="logged-screen">
<div class="icon"><i class="fas fa-check-circle"></i></div>
<h2>Login Confirmado!</h2>
<p>Você já está autenticado no sistema. Continue para acessar sua conta.</p>
<div class="user-info">
<div><strong>Nome:</strong><span id="loggedName">-</span></div>
<div><strong>E-mail:</strong><span id="loggedEmail">-</span></div>
<div><strong>Status:</strong><span style="color:var(--success);font-weight:700">● Online</span></div>
</div>
<div class="btn-group">
<button class="btn" onclick="goToHome()"><i class="fas fa-home"></i>Ir para Home</button>
<button class="btn btn-outline" onclick="logoutUser()"><i class="fas fa-sign-out-alt"></i>Sair da Conta</button>
</div>
</div>
</div>

<!-- Auth Forms -->
<div id="authForms">
<div class="form-header">
<h2 class="form-title">Bem-vindo de Volta</h2>
<p class="form-subtitle">Acesse sua conta ou crie uma nova</p>
</div>

<div class="tabs">
<button class="tab active" onclick="switchTab('login')">Login</button>
<button class="tab" onclick="switchTab('register')">Cadastro</button>
</div>

<div class="alert" id="alert"></div>

<!-- Login -->
<div class="panel active" id="loginPanel">
<form id="loginForm">
<div class="form-group">
<label class="label">E-mail</label>
<input type="email" class="input" id="loginEmail" placeholder="seu@email.com" required autocomplete="email">
</div>
<div class="form-group">
<label class="label">Senha</label>
<div class="input-group">
<input type="password" class="input" id="loginPassword" placeholder="••••••••" required autocomplete="current-password">
<i class="fa fa-eye input-icon" onclick="togglePassword('loginPassword')"></i>
</div>
</div>
<div class="checkbox-group">
<input type="checkbox" id="remember">
<label for="remember">Lembrar</label>
<a href="#" onclick="openForgotModal(event)"><i class="fab fa-whatsapp"></i>Esqueceu?</a>
</div>
<button type="submit" class="btn" id="loginBtn"><i class="fas fa-sign-in-alt"></i>Entrar</button>
</form>
<div class="divider">Ou continue com</div>
<div class="social-btns">
<button class="btn-social" onclick="socialLogin('google')"><i class="fab fa-google"></i>Google</button>
<button class="btn-social" onclick="socialLogin('facebook')"><i class="fab fa-facebook-f"></i>Facebook</button>
</div>
</div>

<!-- Register -->
<div class="panel" id="registerPanel">
<form id="registerForm">
<div class="form-row">
<div class="form-group">
<label class="label">Nome</label>
<input type="text" class="input" id="registerName" placeholder="João" required autocomplete="given-name">
</div>
<div class="form-group">
<label class="label">Sobrenome</label>
<input type="text" class="input" id="registerLastName" placeholder="Silva" required autocomplete="family-name">
</div>
</div>
<div class="form-group">
<label class="label">E-mail</label>
<input type="email" class="input" id="registerEmail" placeholder="seu@email.com" required autocomplete="email">
</div>
<div class="form-group">
<label class="label">WhatsApp</label>
<input type="tel" class="input" id="registerPhone" placeholder="(11) 99999-9999" required autocomplete="tel">
</div>
<div class="form-group">
<label class="label">Senha</label>
<div class="input-group">
<input type="password" class="input" id="registerPassword" placeholder="••••••••" required autocomplete="new-password">
<i class="fa fa-eye input-icon" onclick="togglePassword('registerPassword')"></i>
</div>
</div>
<div class="form-group">
<label class="label">Confirmar Senha</label>
<div class="input-group">
<input type="password" class="input" id="confirmPassword" placeholder="••••••••" required autocomplete="new-password">
<i class="fa fa-eye input-icon" onclick="togglePassword('confirmPassword')"></i>
</div>
</div>
<div class="checkbox-group">
<input type="checkbox" id="terms" required>
<label for="terms">Aceito os Termos de Uso</label>
</div>
<button type="submit" class="btn" id="registerBtn"><i class="fas fa-user-plus"></i>Criar Conta</button>
</form>
<div class="divider">Ou cadastre-se com</div>
<div class="social-btns">
<button class="btn-social" onclick="socialLogin('google')"><i class="fab fa-google"></i>Google</button>
<button class="btn-social" onclick="socialLogin('facebook')"><i class="fab fa-facebook-f"></i>Facebook</button>
</div>
</div>
</div>
</div>
</div>
</div>

<!-- Forgot Password Modal -->
<div class="modal" id="forgotModal">
<div class="modal-box">
<div class="modal-header">
<h3 class="modal-title">Recuperar Senha via WhatsApp</h3>
<button class="modal-close" onclick="closeForgotModal()">×</button>
</div>
<div class="modal-icon"><i class="fab fa-whatsapp"></i></div>
<p class="modal-desc">Digite seu WhatsApp cadastrado e enviaremos uma nova senha temporária para você acessar sua conta.</p>
<div class="whatsapp-info">
<strong><i class="fas fa-shield-halved"></i> Seguro e Rápido</strong>
Você receberá uma senha única gerada aleatoriamente. Recomendamos alterá-la após o login.
</div>
<form id="forgotForm">
<div class="form-group">
<label class="label">WhatsApp</label>
<input type="tel" class="input" id="forgotPhone" placeholder="(11) 99999-9999" required>
</div>
<button type="submit" class="btn" id="forgotBtn" style="background:var(--whatsapp)"><i class="fab fa-whatsapp"></i>Enviar Nova Senha</button>
<button type="button" class="btn btn-outline" onclick="closeForgotModal()" style="margin-top:12px">Cancelar</button>
</form>
</div>
</div>

<script type="module">
import{initializeApp}from'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
import{getFirestore,doc,getDoc,setDoc,collection,query,where,getDocs,updateDoc}from'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
import{getAuth,signInWithEmailAndPassword,createUserWithEmailAndPassword,signInWithPopup,GoogleAuthProvider,FacebookAuthProvider,onAuthStateChanged,signOut,updatePassword}from'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';

const app=initializeApp({apiKey:"AIzaSyCLJ5jo4JknJAe9OlH10EawYEvqjJGnvKg",authDomain:"myfrancashop.firebaseapp.com",projectId:"myfrancashop",storageBucket:"myfrancashop.firebasestorage.app",messagingSenderId:"935759870053",appId:"1:935759870053:web:aabe4af138691d021bee8c"});

const db=getFirestore(app);
const auth=getAuth(app);

function sanitize(str){
const div=document.createElement('div');
div.textContent=str;
return div.innerHTML;
}

function generatePassword(){
const chars='ABCDEFGHJKLMNPQRSTUVWXYZabcdefghjkmnpqrstuvwxyz23456789@#$%&*';
let password='';
for(let i=0;i<12;i++){
password+=chars.charAt(Math.floor(Math.random()*chars.length));
}
return password+Date.now().toString(36).slice(-4);
}

function formatPhone(phone){
return phone.replace(/\D/g,'');
}

function setLoading(btnId,loading){
const btn=document.getElementById(btnId);
if(!btn)return;
if(loading){
btn.disabled=true;
btn.innerHTML='<span class="spinner"></span>Aguarde...';
}else{
btn.disabled=false;
if(btnId==='loginBtn')btn.innerHTML='<i class="fas fa-sign-in-alt"></i>Entrar';
else if(btnId==='registerBtn')btn.innerHTML='<i class="fas fa-user-plus"></i>Criar Conta';
else if(btnId==='forgotBtn')btn.innerHTML='<i class="fab fa-whatsapp"></i>Enviar Nova Senha';
}
}

function showAlert(msg,type='success'){
const alert=document.getElementById('alert');
alert.textContent=msg;
alert.className=`alert show alert-${type}`;
setTimeout(()=>alert.className='alert',5000);
}

window.togglePassword=id=>{
const input=document.getElementById(id);
const icon=input.nextElementSibling;
if(input.type==='password'){
input.type='text';
icon.classList.replace('fa-eye','fa-eye-slash');
}else{
input.type='password';
icon.classList.replace('fa-eye-slash','fa-eye');
}
};

window.switchTab=tab=>{
const tabs=document.querySelectorAll('.tab');
const panels=document.querySelectorAll('.panel');
document.getElementById('alert').className='alert';
if(tab==='login'){
tabs[0].classList.add('active');
tabs[1].classList.remove('active');
panels[0].classList.add('active');
panels[1].classList.remove('active');
}else{
tabs[0].classList.remove('active');
tabs[1].classList.add('active');
panels[0].classList.remove('active');
panels[1].classList.add('active');
}
};

window.openForgotModal=e=>{
e.preventDefault();
document.getElementById('forgotModal').classList.add('active');
document.getElementById('forgotPhone').value='';
document.getElementById('forgotPhone').focus();
};

window.closeForgotModal=()=>{
document.getElementById('forgotModal').classList.remove('active');
};

async function saveUserData(user){
try{
const userDoc=await getDoc(doc(db,'users',user.uid));
const userData=userDoc.exists()?userDoc.data():{};
let isAdmin=false;
try{
const adminDoc=await getDoc(doc(db,'admins',user.uid));
isAdmin=adminDoc.exists();
}catch(e){}
const safeUser={
email:sanitize(user.email||''),
firstName:sanitize(userData.name||''),
lastName:sanitize(userData.lastName||''),
phone:sanitize(userData.phone||''),
avatar:sanitize(userData.photoURL||user.photoURL||''),
isAdmin:!!isAdmin,
createdAt:userData.createdAt?.toDate?.()?.toISOString()||new Date().toISOString(),
uid:user.uid
};
localStorage.setItem('currentUser',JSON.stringify(safeUser));
const users=JSON.parse(localStorage.getItem('users')||'[]');
const idx=users.findIndex(u=>u.email===user.email);
if(idx>=0)users[idx]=safeUser;else users.push(safeUser);
localStorage.setItem('users',JSON.stringify(users));
}catch(e){console.error('Erro ao salvar:',e)}
}

document.getElementById('loginForm').addEventListener('submit',async e=>{
e.preventDefault();
const email=sanitize(document.getElementById('loginEmail').value.trim());
const password=document.getElementById('loginPassword').value;
if(!email||!password){showAlert('Preencha todos os campos!','error');return}
setLoading('loginBtn',true);
try{
const userCredential=await signInWithEmailAndPassword(auth,email,password);
await saveUserData(userCredential.user);
showAlert('Login realizado! Redirecionando...','success');
setTimeout(()=>window.location.href='home.html',1500);
}catch(error){
console.error('Erro:',error);
let msg='Erro ao fazer login.';
if(error.code==='auth/user-not-found'||error.code==='auth/wrong-password'||error.code==='auth/invalid-credential')msg='E-mail ou senha incorretos.';
else if(error.code==='auth/invalid-email')msg='E-mail inválido.';
else if(error.code==='auth/too-many-requests')msg='Muitas tentativas. Aguarde.';
showAlert(msg,'error');
}finally{setLoading('loginBtn',false)}
});

document.getElementById('registerForm').addEventListener('submit',async e=>{
e.preventDefault();
const name=sanitize(document.getElementById('registerName').value.trim());
const lastName=sanitize(document.getElementById('registerLastName').value.trim());
const email=sanitize(document.getElementById('registerEmail').value.trim());
const phone=formatPhone(document.getElementById('registerPhone').value);
const password=document.getElementById('registerPassword').value;
const confirmPass=document.getElementById('confirmPassword').value;
if(!name||!lastName||!email||!phone||!password||!confirmPass){showAlert('Preencha todos os campos!','error');return}
if(password!==confirmPass){showAlert('As senhas não coincidem!','error');return}
if(password.length<6){showAlert('Senha deve ter no mínimo 6 caracteres!','error');return}
if(phone.length<10){showAlert('WhatsApp inválido!','error');return}
setLoading('registerBtn',true);
try{
const userCredential=await createUserWithEmailAndPassword(auth,email,password);
const user=userCredential.user;
await setDoc(doc(db,'users',user.uid),{
name,
lastName,
email,
phone,
photoURL:'',
createdAt:new Date(),
updatedAt:new Date()
});
await saveUserData(user);
showAlert('Conta criada! Redirecionando...','success');
setTimeout(()=>window.location.href='home.html',1500);
}catch(error){
console.error('Erro:',error);
let msg='Erro ao criar conta.';
if(error.code==='auth/email-already-in-use')msg='E-mail já cadastrado!';
else if(error.code==='auth/invalid-email')msg='E-mail inválido!';
else if(error.code==='auth/weak-password')msg='Senha muito fraca!';
showAlert(msg,'error');
}finally{setLoading('registerBtn',false)}
});

window.socialLogin=async provider=>{
try{
let authProvider;
if(provider==='google')authProvider=new GoogleAuthProvider();
else if(provider==='facebook')authProvider=new FacebookAuthProvider();
const result=await signInWithPopup(auth,authProvider);
const user=result.user;
const userDoc=await getDoc(doc(db,'users',user.uid));
if(!userDoc.exists()){
const names=(user.displayName||'').split(' ');
await setDoc(doc(db,'users',user.uid),{
name:names[0]||'',
lastName:names.slice(1).join(' ')||'',
email:user.email,
phone:'',
photoURL:user.photoURL||'',
createdAt:new Date(),
updatedAt:new Date()
});
}
await saveUserData(user);
showAlert('Login realizado! Redirecionando...','success');
setTimeout(()=>window.location.href='index.html',1500);
}catch(error){
console.error('Erro:',error);
showAlert('Erro ao fazer login social.','error');
}
};

document.getElementById('forgotForm').addEventListener('submit',async e=>{
e.preventDefault();
const phone=formatPhone(document.getElementById('forgotPhone').value);
if(!phone||phone.length<10){showAlert('WhatsApp inválido!','error');return}
setLoading('forgotBtn',true);
try{
const q=query(collection(db,'users'),where('phone','==',phone));
const snap=await getDocs(q);
if(snap.empty){
showAlert('WhatsApp não encontrado!','error');
setLoading('forgotBtn',false);
return;
}
const userDoc=snap.docs[0];
const userData=userDoc.data();
const newPassword=generatePassword();
const userAuth=auth.currentUser;
if(userAuth&&userAuth.email===userData.email){
await updatePassword(userAuth,newPassword);
}
await updateDoc(doc(db,'users',userDoc.id),{
tempPassword:newPassword,
updatedAt:new Date()
});
showAlert(`Nova senha enviada para WhatsApp ${phone}!`,'success');
setTimeout(()=>closeForgotModal(),2000);
}catch(error){
console.error('Erro:',error);
showAlert('Erro ao recuperar senha.','error');
}finally{setLoading('forgotBtn',false)}
});

onAuthStateChanged(auth,async user=>{
if(user){
await saveUserData(user);
const userData=JSON.parse(localStorage.getItem('currentUser')||'{}');
const displayName=`${userData.firstName||''} ${userData.lastName||''}`.trim()||user.displayName||'Usuário';
document.getElementById('loggedName').textContent=displayName;
document.getElementById('loggedEmail').textContent=user.email;
document.getElementById('loggedScreen').style.display='block';
document.getElementById('authForms').style.display='none';
}else{
document.getElementById('loggedScreen').style.display='none';
document.getElementById('authForms').style.display='block';
}
});

window.goToHome=()=>{
window.location.href='home.html';
};

window.logoutUser=async()=>{
try{
await signOut(auth);
localStorage.removeItem('currentUser');
document.getElementById('loggedScreen').style.display='none';
document.getElementById('authForms').style.display='block';
showAlert('Logout realizado!','success');
}catch(error){
console.error('Erro:',error);
showAlert('Erro ao fazer logout.','error');
}
};
</script>

</body>
</html>