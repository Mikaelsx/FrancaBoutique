<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>ColorShop - Produtos</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link rel="stylesheet" href="reset.css">
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{--bg:#fff;--text:#000;--gray:#4b4848;--border:#e5e5e5;--overlay:rgba(255, 255, 255, 0.5);--green:#22c55e;--yellow:#eab308;--red:#ef4444;--success:#16a34a;--error:#ef4444}
body{font-family:'Inter',sans-serif;background:var(--bg);color:var(--text);overflow-x:hidden}

/* Action Buttons */
.action-btn{position:fixed;right:32px;width:48px;height:48px;border-radius:50%;background:var(--text);color:#fff;border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:16px;box-shadow:0 4px 16px rgba(0,0,0,0.15);transition:all .3s;z-index:999}
.action-btn:hover{transform:scale(1.05);box-shadow:0 6px 20px rgba(0,0,0,0.25)}
.btn-home{bottom:152px;background:#666}
.btn-cart{bottom:92px}
.btn-filter{bottom:32px}

/* Products Grid */
.products-container{padding:0}
.products-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:0}
.product-card{position:relative;aspect-ratio:3/4;overflow:hidden;cursor:pointer;background:var(--bg)}
.product-img{width:100%;height:100%;object-fit:cover;transition:all .6s ease}
.product-card:hover .product-img{transform:scale(1.05);opacity:0.6}
.product-overlay{position:absolute;inset:0;background:var(--overlay);backdrop-filter:blur(0px);opacity:0;transition:opacity .4s;display:flex;flex-direction:column;justify-content:center;align-items:center;padding:40px;pointer-events:none}
.product-card:hover .product-overlay{opacity:1;pointer-events:auto}

/* Image Navigation */
.image-nav{position:absolute;bottom:20px;left:50%;transform:translateX(-50%);display:flex;gap:12px;z-index:12;opacity:0;transition:opacity .3s}
.product-card:hover .image-nav{opacity:1}
.nav-arrow{width:36px;height:36px;border-radius:50%;background:rgba(255,255,255,0.95);backdrop-filter:blur(10px);border:none;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all .3s;box-shadow:0 2px 8px rgba(0,0,0,0.15)}
.nav-arrow:hover{transform:scale(1.1);box-shadow:0 4px 12px rgba(0,0,0,0.25)}
.nav-arrow i{font-size:14px;color:var(--text)}
.image-counter{padding:8px 16px;background:rgba(255,255,255,0.95);backdrop-filter:blur(10px);border-radius:20px;font-size:11px;font-weight:600;color:var(--text);box-shadow:0 2px 8px rgba(0,0,0,0.15)}

/* Product Actions */
.product-actions{position:absolute;top:16px;right:16px;display:flex;flex-direction:column;gap:8px;z-index:10;pointer-events:auto}
.action-icon{width:40px;height:40px;border-radius:50%;background:rgba(255,255,255,0.95);backdrop-filter:blur(10px);border:none;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all .3s;box-shadow:0 2px 8px rgba(0,0,0,0.1);position:relative}
.action-icon:hover{transform:scale(1.1);box-shadow:0 4px 12px rgba(0,0,0,0.2)}
.action-icon i{font-size:16px;color:var(--text)}
.action-icon.liked i{color:var(--red)}
.like-count{position:absolute;bottom:-6px;right:-6px;background:var(--red);color:#fff;font-size:10px;font-weight:700;padding:2px 6px;border-radius:10px;min-width:20px;text-align:center;box-shadow:0 2px 4px rgba(0,0,0,0.2)}

/* Product Status Badge */
.product-status-badge{position:absolute;top:16px;left:16px;padding:6px 12px;border-radius:20px;font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:1px;display:flex;align-items:center;gap:6px;z-index:10;backdrop-filter:blur(10px)}
.status-available{background:rgba(34,197,94,0.9);color:#fff}
.status-waiting{background:rgba(234,179,8,0.9);color:#fff}
.status-dot{width:6px;height:6px;border-radius:50%;background:currentColor}

.product-details{text-align:center;transform:translateY(20px);transition:transform .4s .1s}
.product-card:hover .product-details{transform:translateY(0)}
.product-code{font-size:11px;font-weight:500;color:var(--gray);letter-spacing:1.5px;text-transform:uppercase;margin-bottom:12px}
.product-name{font-size:20px;font-weight:600;margin-bottom:8px;letter-spacing:-0.5px}
.product-category{font-size:13px;color:var(--gray);margin-bottom:16px;text-transform:uppercase;letter-spacing:1px;font-weight:500}
.product-info-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin:20px 0;text-align:left;width:100%;max-width:300px}
.info-item{display:flex;flex-direction:column;gap:4px}
.info-label{font-size:10px;color:var(--gray);text-transform:uppercase;letter-spacing:1.2px;font-weight:600}
.info-value{font-size:13px;font-weight:500}
.palette-preview{display:flex;gap:6px;margin-top:6px;flex-wrap:wrap}
.palette-color{width:24px;height:24px;border-radius:50%;border:2px solid rgba(0,0,0,0.1);box-shadow:0 2px 4px rgba(0,0,0,0.1)}
.product-prices{margin:20px 0}
.price-row{display:flex;align-items:center;justify-content:center;gap:12px;margin-bottom:4px}
.price-original{font-size:16px;color:var(--gray);text-decoration:line-through}
.price-discount{font-size:28px;font-weight:700;letter-spacing:-1px}
.discount-badge{background:var(--red);color:#fff;font-size:11px;font-weight:700;padding:4px 8px;border-radius:12px;text-transform:uppercase;letter-spacing:0.5px}
.btn-add-cart{padding:12px 32px;background:var(--text);color:#fff;border:none;border-radius:50px;font-size:12px;font-weight:600;text-transform:uppercase;letter-spacing:1.2px;cursor:pointer;transition:all .3s;margin-top:16px}
.btn-add-cart:hover{transform:translateY(-2px);box-shadow:0 8px 16px rgba(0,0,0,0.2)}

/* Loading */
.loading{display:flex;justify-content:center;align-items:center;padding:100px 20px;font-size:14px;color:var(--gray);grid-column:1/-1}
.spinner{display:inline-block;width:20px;height:20px;border:2px solid rgba(0,0,0,0.1);border-top-color:var(--text);border-radius:50%;animation:spin .6s linear infinite;margin-right:12px}
@keyframes spin{to{transform:rotate(360deg)}}

/* Modal */
.modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.7);z-index:10000;align-items:center;justify-content:center;padding:20px;backdrop-filter:blur(5px)}
.modal.active{display:flex;animation:fadeIn .3s}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}
.modal-box{background:var(--bg);border-radius:0;width:100%;max-width:500px;max-height:90vh;overflow-y:auto;animation:slideUp .4s;position:relative}
@keyframes slideUp{from{opacity:0;transform:translateY(30px)}to{opacity:1;transform:translateY(0)}}
.modal-header{padding:24px 32px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;position:sticky;top:0;background:var(--bg);z-index:10}
.modal-title{font-size:16px;font-weight:600;text-transform:uppercase;letter-spacing:1.5px}
.modal-close{background:none;border:none;font-size:20px;cursor:pointer;color:var(--gray);padding:0;width:32px;height:32px;display:flex;align-items:center;justify-content:center;transition:all .3s}
.modal-close:hover{color:var(--text);transform:rotate(90deg)}

/* Cart Modal */
.cart-items{padding:24px 32px}
.cart-empty{text-align:center;padding:60px 20px;color:var(--gray)}
.cart-item{display:flex;gap:16px;padding:20px 0;border-bottom:1px solid var(--border)}
.cart-item:last-child{border-bottom:none}
.cart-item-img{width:80px;height:100px;object-fit:cover;border-radius:4px}
.cart-item-info{flex:1;display:flex;flex-direction:column;gap:6px}
.cart-item-name{font-size:14px;font-weight:600}
.cart-item-code{font-size:11px;color:var(--gray);text-transform:uppercase;letter-spacing:1px}
.cart-item-price{font-size:15px;font-weight:700;margin-top:auto}
.cart-item-remove{background:none;border:none;color:var(--gray);cursor:pointer;font-size:18px;padding:4px;transition:all .3s;align-self:flex-start}
.cart-item-remove:hover{color:#ef4444;transform:scale(1.2)}
.cart-footer{padding:24px 32px;border-top:2px solid var(--border);position:sticky;bottom:0;background:var(--bg)}
.cart-total{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;font-size:18px;font-weight:700}
.btn-checkout{width:100%;padding:16px;background:var(--text);color:#fff;border:none;border-radius:50px;font-size:13px;font-weight:600;text-transform:uppercase;letter-spacing:1.5px;cursor:pointer;transition:all .3s}
.btn-checkout:hover{transform:translateY(-2px);box-shadow:0 8px 16px rgba(0,0,0,0.2)}
.btn-checkout:disabled{opacity:0.5;cursor:not-allowed}

/* Filter Modal */
.filter-content{padding:24px 32px;max-height:calc(90vh - 160px);overflow-y:auto}
.filter-section{margin-bottom:24px;padding-bottom:24px;border-bottom:1px solid var(--border)}
.filter-section:last-child{border-bottom:none;margin-bottom:0;padding-bottom:0}
.filter-label{font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:1.5px;margin-bottom:12px;color:var(--gray);display:block}
.filter-input,.filter-select{width:100%;padding:12px 16px;border:1px solid var(--border);border-radius:8px;font-size:14px;font-family:inherit;transition:all .3s;background:var(--bg)}
.filter-input:focus,.filter-select:focus{outline:none;border-color:var(--text);box-shadow:0 0 0 3px rgba(0,0,0,0.05)}
.filter-select{cursor:pointer}
.filter-options{display:flex;flex-wrap:wrap;gap:8px}
.filter-option{padding:8px 16px;border:1px solid var(--border);border-radius:50px;font-size:12px;font-weight:500;cursor:pointer;transition:all .3s;background:var(--bg)}
.filter-option:hover{border-color:var(--text)}
.filter-option.active{background:var(--text);color:#fff;border-color:var(--text)}
.price-range{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.filter-actions{padding:24px 32px;display:flex;gap:12px;position:sticky;bottom:0;background:var(--bg);border-top:1px solid var(--border)}
.btn-clear{flex:1;padding:12px;border:1px solid var(--border);background:var(--bg);border-radius:50px;font-size:12px;font-weight:600;text-transform:uppercase;letter-spacing:1.2px;cursor:pointer;transition:all .3s}
.btn-clear:hover{background:var(--text);color:#fff;border-color:var(--text)}
.btn-apply{flex:1;padding:12px;background:var(--text);color:#fff;border:none;border-radius:50px;font-size:12px;font-weight:600;text-transform:uppercase;letter-spacing:1.2px;cursor:pointer;transition:all .3s}
.btn-apply:hover{transform:translateY(-2px);box-shadow:0 4px 12px rgba(0,0,0,0.2)}

/* Toast */
.toast-container{position:fixed;top:20px;right:20px;z-index:99999;display:flex;flex-direction:column;gap:12px;pointer-events:none}
.toast{background:var(--bg);border:1px solid var(--border);border-radius:12px;padding:16px 20px;box-shadow:0 8px 24px rgba(0,0,0,0.15);display:flex;align-items:center;gap:12px;min-width:300px;animation:toastIn .4s;pointer-events:auto;position:relative;overflow:hidden}
@keyframes toastIn{from{opacity:0;transform:translateX(100px)}to{opacity:1;transform:translateX(0)}}
.toast.removing{animation:toastOut .3s forwards}
@keyframes toastOut{to{opacity:0;transform:translateX(100px)}}
.toast-icon{width:40px;height:40px;min-width:40px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:18px}
.toast-success .toast-icon{background:rgba(22,163,74,0.1);color:var(--success)}
.toast-error .toast-icon{background:rgba(239,68,68,0.1);color:var(--error)}
.toast-content{flex:1}
.toast-title{font-size:14px;font-weight:700;margin-bottom:2px}
.toast-message{font-size:13px;color:var(--gray)}
.toast-close{background:none;border:none;color:var(--gray);cursor:pointer;font-size:18px;padding:0;width:24px;height:24px;display:flex;align-items:center;justify-content:center;transition:all .3s}
.toast-close:hover{color:var(--text)}
.toast-progress{position:absolute;bottom:0;left:0;height:3px;background:var(--text);animation:progress 3s linear forwards}
@keyframes progress{to{width:0}}

@media(max-width:768px){
.products-grid{grid-template-columns:1fr}
.product-overlay{padding:20px}
.product-info-grid{grid-template-columns:1fr;gap:12px}
.action-btn{right:20px;width:44px;height:44px}
.btn-home{bottom:136px}
.btn-cart{bottom:80px}
.btn-filter{bottom:20px}
.modal-box{max-width:100%}
.toast{min-width:auto;max-width:calc(100vw - 40px)}
}
</style>
</head>
<body>

<div class="products-container">
<div class="products-grid" id="productsGrid">
<div class="loading">
<span class="spinner"></span>
Carregando produtos...
</div>
</div>
</div>

<!-- Action Buttons -->
<button class="action-btn btn-home" onclick="goHome()" title="Home">
<i class="fas fa-home"></i>
</button>
<button class="action-btn btn-cart" onclick="openCartModal()" title="Carrinho">
<i class="fas fa-shopping-bag"></i>
</button>
<button class="action-btn btn-filter" onclick="openFilterModal()" title="Filtros">
<i class="fas fa-sliders-h"></i>
</button>

<!-- Cart Modal -->
<div class="modal" id="cartModal">
<div class="modal-box">
<div class="modal-header">
<h3 class="modal-title">Carrinho</h3>
<button class="modal-close" onclick="closeCartModal()"><i class="fas fa-times"></i></button>
</div>
<div class="cart-items" id="cartItems">
<div class="cart-empty">Seu carrinho está vazio</div>
</div>
<div class="cart-footer" id="cartFooter" style="display:none">
<div class="cart-total">
<span>Total</span>
<span id="cartTotal">R$ 0,00</span>
</div>
<button class="btn-checkout" onclick="checkout()">Finalizar Compra</button>
</div>
</div>
</div>

<!-- Filter Modal -->
<div class="modal" id="filterModal">
<div class="modal-box">
<div class="modal-header">
<h3 class="modal-title">Filtros</h3>
<button class="modal-close" onclick="closeFilterModal()"><i class="fas fa-times"></i></button>
</div>
<div class="filter-content">
<div class="filter-section">
<label class="filter-label">Buscar</label>
<input type="text" class="filter-input" id="searchInput" placeholder="Código ou nome do produto...">
</div>
<div class="filter-section">
<div class="filter-label">Categoria</div>
<div class="filter-options" id="categoryFilters"></div>
</div>
<div class="filter-section">
<div class="filter-label">Status</div>
<div class="filter-options" id="statusFilters">
<div class="filter-option" data-status="available">Disponível</div>
<div class="filter-option" data-status="waiting">Em Espera</div>
</div>
</div>
<div class="filter-section">
<label class="filter-label">Paleta de Cores</label>
<select class="filter-select" id="paletteSelect">
<option value="">Todas as paletas</option>
</select>
</div>
<div class="filter-section">
<div class="filter-label">Tamanho</div>
<div class="filter-options" id="sizeFilters"></div>
</div>
<div class="filter-section">
<div class="filter-label">Material</div>
<div class="filter-options" id="materialFilters"></div>
</div>
<div class="filter-section">
<div class="filter-label">Faixa de Preço</div>
<div class="price-range">
<input type="number" class="filter-input" id="minPrice" placeholder="Mín (R$)">
<input type="number" class="filter-input" id="maxPrice" placeholder="Máx (R$)">
</div>
</div>
</div>
<div class="filter-actions">
<button class="btn-clear" onclick="clearFilters()">Limpar</button>
<button class="btn-apply" onclick="applyFilters()">Aplicar</button>
</div>
</div>
</div>

<!-- Toast Container -->
<div class="toast-container" id="toastContainer"></div>

<script type="module">
import{initializeApp}from'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
import{getFirestore,collection,getDocs,doc,getDoc,updateDoc,increment}from'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

const app=initializeApp({apiKey:"AIzaSyCLJ5jo4JknJAe9OlH10EawYEvqjJGnvKg",authDomain:"myfrancashop.firebaseapp.com",projectId:"myfrancashop",storageBucket:"myfrancashop.firebasestorage.app",messagingSenderId:"935759870053",appId:"1:935759870053:web:aabe4af138691d021bee8c"});

const db=getFirestore(app);
let allProducts=[];
let filteredProducts=[];
let cart=[];
let filters={search:'',categories:[],status:[],palette:'',sizes:[],materials:[],minPrice:null,maxPrice:null};
let palettesCache={};
let allPalettes=[];
let likedProducts=new Set();

console.log('Firebase inicializado');

// Toast System
function showToast(message,type='success'){
const container=document.getElementById('toastContainer');
const toast=document.createElement('div');
toast.className=`toast toast-${type}`;

const iconClass=type==='success'?'fa-circle-check':'fa-circle-exclamation';
const title=type==='success'?'Sucesso':'Erro';

toast.innerHTML=`
<div class="toast-icon">
<i class="fas ${iconClass}"></i>
</div>
<div class="toast-content">
<div class="toast-title">${title}</div>
<div class="toast-message">${message}</div>
</div>
<button class="toast-close" onclick="this.parentElement.remove()">
<i class="fas fa-times"></i>
</button>
<div class="toast-progress"></div>
`;

container.appendChild(toast);

setTimeout(()=>{
toast.classList.add('removing');
setTimeout(()=>toast.remove(),300);
},3000);
}

window.goHome=()=>{
window.location.href='home.html';
};

// Load cart and likes
function loadCart(){
const saved=localStorage.getItem('colorshop_cart');
if(saved){
try{cart=JSON.parse(saved)}catch(e){cart=[]}
}
updateCartDisplay();
}

function loadLikes(){
const saved=localStorage.getItem('colorshop_likes');
if(saved){
try{likedProducts=new Set(JSON.parse(saved))}catch(e){likedProducts=new Set()}
}
}

function saveLikes(){
localStorage.setItem('colorshop_likes',JSON.stringify([...likedProducts]));
}

function saveCart(){
localStorage.setItem('colorshop_cart',JSON.stringify(cart));
updateCartDisplay();
}

function addToCart(product){
const exists=cart.find(item=>item.id===product.id);
if(exists){
showToast('Este produto já está no carrinho!','error');
return;
}
cart.push({
id:product.id,
code:product.code,
name:product.name,
price:product.finalPrice,
image:product.images&&product.images[0]?product.images[0]:''
});
saveCart();
showToast('Produto adicionado ao carrinho!','success');
}

function removeFromCart(id){
cart=cart.filter(item=>item.id!==id);
saveCart();
showToast('Produto removido do carrinho!','success');
}

function updateCartDisplay(){
const itemsEl=document.getElementById('cartItems');
const footerEl=document.getElementById('cartFooter');
const totalEl=document.getElementById('cartTotal');

if(cart.length===0){
itemsEl.innerHTML='<div class="cart-empty">Seu carrinho está vazio</div>';
footerEl.style.display='none';
}else{
itemsEl.innerHTML=cart.map(item=>`
<div class="cart-item">
${item.image?`<img src="${item.image}" class="cart-item-img" alt="${item.name}">`:'<div class="cart-item-img" style="background:#f5f5f5;display:flex;align-items:center;justify-content:center;color:#999"><i class="fas fa-image"></i></div>'}
<div class="cart-item-info">
<div class="cart-item-name">${item.name}</div>
<div class="cart-item-code">${item.code}</div>
<div class="cart-item-price">${formatPrice(item.price)}</div>
</div>
<button class="cart-item-remove" onclick="removeFromCart('${item.id}')"><i class="fas fa-trash"></i></button>
</div>
`).join('');
footerEl.style.display='block';
const total=cart.reduce((sum,item)=>sum+(parseFloat(item.price)||0),0);
totalEl.textContent=formatPrice(total);
}
}

// Like functionality
async function toggleLike(productId){
const productRef=doc(db,'products',productId);

if(likedProducts.has(productId)){
likedProducts.delete(productId);
try{
await updateDoc(productRef,{likes:increment(-1)});
}catch(e){
console.error('Erro ao remover like:',e);
}
}else{
likedProducts.add(productId);
try{
await updateDoc(productRef,{likes:increment(1)});
}catch(e){
console.error('Erro ao adicionar like:',e);
}
}
saveLikes();
renderProducts();
}

window.toggleLike=toggleLike;
window.removeFromCart=removeFromCart;

window.openCartModal=()=>document.getElementById('cartModal').classList.add('active');
window.closeCartModal=()=>document.getElementById('cartModal').classList.remove('active');
window.openFilterModal=()=>document.getElementById('filterModal').classList.add('active');
window.closeFilterModal=()=>document.getElementById('filterModal').classList.remove('active');

window.checkout=()=>{
showToast('Função de compra em desenvolvimento!','error');
};

// Load palettes
async function loadAllPalettes(){
try{
console.log('Carregando paletas...');
const snap=await getDocs(collection(db,'colorPalettes'));
allPalettes=[];
snap.forEach(doc=>{
const data=doc.data();
allPalettes.push({
id:doc.id,
name:data.name||doc.id,
colors:data.colors||[]
});
palettesCache[doc.id]={name:data.name||doc.id,colors:data.colors||[]};
});
console.log('Paletas carregadas:',allPalettes.length);

// Popular o select de paletas
const paletteSelect=document.getElementById('paletteSelect');
if(paletteSelect){
paletteSelect.innerHTML='<option value="">Todas as paletas</option>'+
allPalettes.map(p=>`<option value="${p.id}">${p.name}</option>`).join('');
}
}catch(e){
console.error('Erro ao carregar paletas:',e);
}
}

async function loadPalette(paletteId){
if(!paletteId)return{name:'',colors:[]};
if(palettesCache[paletteId])return palettesCache[paletteId];
try{
const paletteDoc=await getDoc(doc(db,'colorPalettes',paletteId));
if(paletteDoc.exists()){
const data=paletteDoc.data();
const palette={name:data.name||paletteId,colors:data.colors||[]};
palettesCache[paletteId]=palette;
return palette;
}
}catch(e){
console.error('Erro ao carregar paleta:',e);
}
return{name:paletteId,colors:[]};
}

// Load products
async function loadProducts(){
const grid=document.getElementById('productsGrid');
try{
console.log('Iniciando carregamento de produtos...');
await loadAllPalettes();

const snap=await getDocs(collection(db,'products'));
console.log('Documentos carregados:',snap.size);
allProducts=[];
const categories=new Set();
const sizes=new Set();
const materials=new Set();

for(const docSnap of snap.docs){
const data=docSnap.data();
console.log('Produto:',docSnap.id,data);
// Validação: não exibir se não tiver imagem válida ou status sold
const hasValidImage=data.images&&Array.isArray(data.images)&&data.images.length>0&&data.images[0]&&data.images[0].trim()!=='';
if(data.status!=='sold'&&hasValidImage){
const product={id:docSnap.id,...data};
if(!product.likes)product.likes=0;

// Calcular preço final (com desconto se houver)
const basePrice=parseFloat(product.price)||0;
const discountPrice=product.discountPrice?parseFloat(product.discountPrice):null;
product.finalPrice=discountPrice&&discountPrice<basePrice?discountPrice:basePrice;

if(product.paletteId){
const palette=await loadPalette(product.paletteId);
product.paletteName=palette.name;
product.paletteColors=palette.colors;
}
allProducts.push(product);
if(data.category)categories.add(data.category);
if(data.size)sizes.add(data.size);
if(data.material)materials.add(data.material);
}
}

console.log('Produtos válidos carregados:',allProducts.length);

// Setup filters
const catFilter=document.getElementById('categoryFilters');
catFilter.innerHTML=Array.from(categories).map(cat=>
`<div class="filter-option" data-category="${cat}">${cat}</div>`
).join('');

const sizeFilter=document.getElementById('sizeFilters');
sizeFilter.innerHTML=Array.from(sizes).map(size=>
`<div class="filter-option" data-size="${size}">${size}</div>`
).join('');

const materialFilter=document.getElementById('materialFilters');
materialFilter.innerHTML=Array.from(materials).map(material=>
`<div class="filter-option" data-material="${material}">${material}</div>`
).join('');

// Add filter listeners
document.querySelectorAll('.filter-option').forEach(el=>{
el.addEventListener('click',()=>el.classList.toggle('active'));
});

filteredProducts=[...allProducts];
renderProducts();
}catch(e){
console.error('Erro ao carregar produtos:',e);
grid.innerHTML='<div class="loading" style="color:#ef4444">Erro ao carregar produtos: '+e.message+'</div>';
}
}

function renderProducts(){
const grid=document.getElementById('productsGrid');
if(filteredProducts.length===0){
grid.innerHTML='<div class="loading">Nenhum produto encontrado</div>';
return;
}
grid.innerHTML=filteredProducts.map(p=>createProductCard(p)).join('');
}

function createProductCard(p){
const statusClass=p.status==='available'?'status-available':'status-waiting';
const statusText=p.status==='available'?'Disponível':'Em Espera';
const hasDiscount=p.discountPrice&&parseFloat(p.discountPrice)<parseFloat(p.price);
const paletteColors=p.paletteColors||[];
const img=p.images&&p.images[0]?p.images[0]:'';
const isLiked=likedProducts.has(p.id);
const likesCount=p.likes||0;
const finalPrice=p.finalPrice||p.price;

return`
<div class="product-card">
<img src="${img}" class="product-img" alt="${p.name||'Produto'}" loading="lazy">
<div class="product-status-badge ${statusClass}">
<span class="status-dot"></span>
${statusText}
</div>
<div class="product-actions">
<button class="action-icon ${isLiked?'liked':''}" onclick="toggleLike('${p.id}')" title="Curtir">
<i class="fas fa-heart"></i>
${likesCount>0?`<span class="like-count">${likesCount}</span>`:''}
</button>
</div>
<div class="product-overlay">
<div class="product-details">
<div class="product-code">${p.code||'---'}</div>
<div class="product-name">${p.name||'Produto'}</div>
<div class="product-category">${p.category||'Sem categoria'}</div>
<div class="product-info-grid">
<div class="info-item">
<div class="info-label">Paleta</div>
<div class="info-value">
${paletteColors.length>0?`<div class="palette-preview">${paletteColors.slice(0,6).map(c=>`<div class="palette-color" style="background:${c}"></div>`).join('')}</div>`:'N/A'}
</div>
</div>
<div class="info-item">
<div class="info-label">Tamanho</div>
<div class="info-value">${p.size||'N/A'}</div>
</div>
<div class="info-item">
<div class="info-label">Material</div>
<div class="info-value">${p.material||'N/A'}</div>
</div>
<div class="info-item">
<div class="info-label">Status</div>
<div class="info-value">${statusText}</div>
</div>
</div>
<div class="product-prices">
${hasDiscount?`
<div class="price-row">
<div class="price-original">${formatPrice(p.price)}</div>
<div class="discount-badge">-${Math.round(((parseFloat(p.price)-parseFloat(p.discountPrice))/parseFloat(p.price))*100)}%</div>
</div>
`:''}
<div class="price-discount">${formatPrice(finalPrice)}</div>
</div>
<button class="btn-add-cart" onclick='addToCartFromCard(${JSON.stringify({id:p.id,code:p.code,name:p.name,finalPrice:finalPrice,images:p.images})})'>
Adicionar ao Carrinho
</button>
</div>
</div>
</div>
`;
}

window.addToCartFromCard=(product)=>{
addToCart(product);
};

window.clearFilters=()=>{
document.querySelectorAll('.filter-option.active').forEach(el=>el.classList.remove('active'));
document.getElementById('searchInput').value='';
document.getElementById('paletteSelect').value='';
document.getElementById('minPrice').value='';
document.getElementById('maxPrice').value='';
filters={search:'',categories:[],status:[],palette:'',sizes:[],materials:[],minPrice:null,maxPrice:null};
filteredProducts=[...allProducts];
renderProducts();
};

window.applyFilters=()=>{
const searchTerm=document.getElementById('searchInput').value.toLowerCase().trim();
filters.search=searchTerm;
filters.categories=Array.from(document.querySelectorAll('#categoryFilters .filter-option.active')).map(el=>el.dataset.category);
filters.status=Array.from(document.querySelectorAll('#statusFilters .filter-option.active')).map(el=>el.dataset.status);
filters.palette=document.getElementById('paletteSelect').value;
filters.sizes=Array.from(document.querySelectorAll('#sizeFilters .filter-option.active')).map(el=>el.dataset.size);
filters.materials=Array.from(document.querySelectorAll('#materialFilters .filter-option.active')).map(el=>el.dataset.material);
filters.minPrice=parseFloat(document.getElementById('minPrice').value)||null;
filters.maxPrice=parseFloat(document.getElementById('maxPrice').value)||null;

filteredProducts=allProducts.filter(p=>{
// Search filter
if(filters.search){
const searchMatch=
(p.code||'').toLowerCase().includes(filters.search)||
(p.name||'').toLowerCase().includes(filters.search);
if(!searchMatch)return false;
}

// Category filter
if(filters.categories.length>0&&!filters.categories.includes(p.category))return false;

// Status filter
if(filters.status.length>0&&!filters.status.includes(p.status))return false;

// Palette filter
if(filters.palette&&p.paletteId!==filters.palette)return false;

// Size filter
if(filters.sizes.length>0&&!filters.sizes.includes(p.size))return false;

// Material filter
if(filters.materials.length>0&&!filters.materials.includes(p.material))return false;

// Price filter (usando o preço final)
const price=parseFloat(p.finalPrice)||0;
if(filters.minPrice!==null&&price<filters.minPrice)return false;
if(filters.maxPrice!==null&&price>filters.maxPrice)return false;

return true;
});

renderProducts();
closeFilterModal();
showToast(`${filteredProducts.length} produto(s) encontrado(s)!`,'success');
};

function formatPrice(p){
if(!p||isNaN(p))return'R$ 0,00';
return`R$ ${parseFloat(p).toFixed(2).replace('.',',')}`;
}

loadCart();
loadLikes();
loadProducts();
</script>
</body>
</html>