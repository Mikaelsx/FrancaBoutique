<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>ColorShop - Analytics</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{--bg:#fff;--text:#000;--gray:#666;--border:#e5e5e5;--light:#f9fafb;--primary:rgb(201,20,20);--success:#16a34a;--error:#ef4444;--warning:#f59e0b}
body{font-family:Inter,sans-serif;background:var(--light);color:var(--text);min-height:100vh}

/* Password Screen */
.password-screen{display:flex;align-items:center;justify-content:center;min-height:100vh;padding:20px;background:linear-gradient(135deg,rgba(0,0,0,.9),rgba(201,20,20,.8))}
.password-box{background:var(--bg);border-radius:16px;padding:48px;max-width:450px;width:100%;box-shadow:0 20px 60px rgba(0,0,0,.3);animation:slideUp .5s}
@keyframes slideUp{from{opacity:0;transform:translateY(30px)}to{opacity:1;transform:translateY(0)}}
.password-icon{width:80px;height:80px;background:var(--primary);color:#fff;display:flex;align-items:center;justify-content:center;font-size:36px;margin:0 auto 24px;border-radius:50%;box-shadow:0 8px 24px rgba(201,20,20,.3)}
.password-title{font-size:24px;font-weight:900;text-align:center;margin-bottom:12px;letter-spacing:-1px}
.password-subtitle{font-size:14px;color:var(--gray);text-align:center;margin-bottom:32px}
.form-group{margin-bottom:20px}
.label{display:block;font-size:12px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;margin-bottom:8px}
.input{width:100%;padding:14px 16px;border:1px solid var(--border);border-radius:12px;font-size:15px;font-family:inherit;background:var(--light);transition:all .3s;font-weight:500}
.input:focus{outline:none;border-color:var(--text);background:var(--bg);box-shadow:0 0 0 3px rgba(0,0,0,.05)}
.btn{width:100%;padding:16px;border:none;border-radius:50px;font-size:13px;font-weight:700;cursor:pointer;transition:all .3s;font-family:inherit;text-transform:uppercase;letter-spacing:.8px;background:var(--primary);color:#fff;display:flex;align-items:center;justify-content:center;gap:10px}
.btn:hover:not(:disabled){transform:translateY(-3px);box-shadow:0 12px 32px rgba(201,20,20,.4)}
.btn:disabled{opacity:.5;cursor:not-allowed}
.alert{padding:12px 16px;margin-bottom:20px;border-radius:12px;font-size:13px;font-weight:600;display:none}
.alert.show{display:block;animation:fadeIn .3s}
@keyframes fadeIn{from{opacity:0;transform:translateY(-10px)}to{opacity:1;transform:translateY(0)}}
.alert-error{background:rgba(239,68,68,.1);border:1px solid var(--error);color:#991b1b}

/* Dashboard */
.dashboard{display:none;padding:32px;max-width:1600px;margin:0 auto}
.dashboard.active{display:block}
.dashboard-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:32px;flex-wrap:wrap;gap:16px}
.dashboard-title{font-size:32px;font-weight:900;letter-spacing:-1.5px}
.dashboard-actions{display:flex;gap:12px;flex-wrap:wrap}
.btn-secondary{padding:12px 24px;background:var(--text);color:#fff;border:none;border-radius:50px;font-size:12px;font-weight:700;cursor:pointer;transition:all .3s;text-transform:uppercase;letter-spacing:.8px;display:flex;align-items:center;gap:8px}
.btn-secondary:hover{transform:translateY(-2px);box-shadow:0 8px 20px rgba(0,0,0,.2)}
.btn-outline{background:transparent;color:var(--text);border:2px solid var(--border)}
.btn-outline:hover{background:var(--text);color:#fff;border-color:var(--text)}

/* Stats Cards */
.stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:20px;margin-bottom:32px}
.stat-card{background:var(--bg);border:1px solid var(--border);border-radius:16px;padding:24px;transition:all .3s}
.stat-card:hover{transform:translateY(-4px);box-shadow:0 8px 24px rgba(0,0,0,.08)}
.stat-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:16px}
.stat-label{font-size:12px;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:var(--gray)}
.stat-icon{width:48px;height:48px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:20px}
.icon-primary{background:rgba(201,20,20,.1);color:var(--primary)}
.icon-success{background:rgba(22,163,74,.1);color:var(--success)}
.icon-warning{background:rgba(245,158,11,.1);color:var(--warning)}
.stat-value{font-size:36px;font-weight:900;letter-spacing:-2px;margin-bottom:8px}
.stat-footer{font-size:13px;color:var(--gray);display:flex;align-items:center;gap:6px}
.stat-badge{padding:4px 10px;background:rgba(22,163,74,.1);color:var(--success);border-radius:12px;font-size:11px;font-weight:700}

/* Table Section */
.table-section{background:var(--bg);border:1px solid var(--border);border-radius:16px;padding:24px;margin-bottom:32px}
.section-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:24px;flex-wrap:wrap;gap:12px}
.section-title{font-size:18px;font-weight:900;letter-spacing:-.5px}
.table-actions{display:flex;gap:12px;flex-wrap:wrap}
.btn-small{padding:10px 20px;font-size:11px}
.search-box{position:relative;min-width:280px}
.search-input{width:100%;padding:10px 16px 10px 40px;border:1px solid var(--border);border-radius:50px;font-size:13px;font-family:inherit;background:var(--light)}
.search-input:focus{outline:none;border-color:var(--text);background:var(--bg)}
.search-icon{position:absolute;left:14px;top:50%;transform:translateY(-50%);color:var(--gray);font-size:14px}

/* Table */
.table-container{overflow-x:auto;margin-top:20px}
.table{width:100%;border-collapse:collapse}
.table th{text-align:left;padding:12px 16px;font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:var(--gray);border-bottom:2px solid var(--border);white-space:nowrap}
.table td{padding:16px;border-bottom:1px solid var(--border);font-size:14px}
.table tbody tr{transition:background .2s}
.table tbody tr:hover{background:var(--light)}
.table-img{width:50px;height:60px;object-fit:cover;border-radius:8px}
.status-badge{padding:6px 12px;border-radius:20px;font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;display:inline-block}
.status-available{background:rgba(22,163,74,.1);color:var(--success)}
.status-waiting{background:rgba(245,158,11,.1);color:var(--warning)}
.status-sold{background:rgba(239,68,68,.1);color:var(--error)}
.table-actions-cell{display:flex;gap:8px}
.icon-btn{width:32px;height:32px;border-radius:50%;border:1px solid var(--border);background:var(--light);display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all .3s;font-size:13px}
.icon-btn:hover{background:var(--text);color:#fff;transform:scale(1.1)}
.price-cell{font-weight:700;color:var(--success)}

/* Modal */
.modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:10000;align-items:center;justify-content:center;padding:20px;backdrop-filter:blur(5px)}
.modal.active{display:flex;animation:fadeIn .3s}
.modal-box{background:var(--bg);border-radius:16px;padding:0;max-width:700px;width:100%;max-height:90vh;overflow:hidden;animation:slideUp .4s;display:flex;flex-direction:column}
.modal-header{padding:24px 32px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
.modal-title{font-size:18px;font-weight:900;letter-spacing:-.5px}
.modal-close{background:none;border:none;font-size:24px;cursor:pointer;color:var(--gray);padding:0;width:32px;height:32px;display:flex;align-items:center;justify-content:center;border-radius:50%;transition:all .3s}
.modal-close:hover{background:var(--light);color:var(--text)}
.modal-content{padding:32px;overflow-y:auto;flex:1}
.modal-footer{padding:24px 32px;border-top:1px solid var(--border);display:flex;gap:12px;justify-content:flex-end}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:20px}
.form-group-full{grid-column:1/-1}
.textarea{min-height:100px;resize:vertical}
.select{width:100%;padding:14px 16px;border:1px solid var(--border);border-radius:12px;font-size:14px;font-family:inherit;background:var(--light);cursor:pointer;transition:all .3s}
.select:focus{outline:none;border-color:var(--text);background:var(--bg)}
.image-preview{display:flex;gap:12px;flex-wrap:wrap;margin-top:12px}
.preview-item{position:relative;width:80px;height:100px;border-radius:8px;overflow:hidden;border:2px solid var(--border)}
.preview-img{width:100%;height:100%;object-fit:cover}
.preview-remove{position:absolute;top:4px;right:4px;width:24px;height:24px;border-radius:50%;background:rgba(0,0,0,.8);color:#fff;border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:12px;transition:all .3s}
.preview-remove:hover{background:var(--error);transform:scale(1.1)}

/* Sales Table */
.sales-filters{display:flex;gap:12px;margin-bottom:20px;flex-wrap:wrap}
.filter-select{padding:10px 16px;border:1px solid var(--border);border-radius:50px;font-size:13px;font-family:inherit;background:var(--bg);cursor:pointer}
.filter-select:focus{outline:none;border-color:var(--text)}

/* Loading */
.loading{display:flex;justify-content:center;align-items:center;padding:60px;color:var(--gray)}
.spinner{display:inline-block;width:20px;height:20px;border:2px solid rgba(0,0,0,.1);border-top-color:var(--text);border-radius:50%;animation:spin .6s linear infinite;margin-right:12px}
@keyframes spin{to{transform:rotate(360deg)}}

/* Toast */
.toast-container{position:fixed;top:20px;right:20px;z-index:99999;display:flex;flex-direction:column;gap:12px}
.toast{background:var(--bg);border:1px solid var(--border);border-radius:12px;padding:16px 20px;box-shadow:0 8px 24px rgba(0,0,0,.15);display:flex;align-items:center;gap:12px;min-width:300px;animation:toastIn .4s}
@keyframes toastIn{from{opacity:0;transform:translateX(100px)}to{opacity:1;transform:translateX(0)}}
.toast.removing{animation:toastOut .3s forwards}
@keyframes toastOut{to{opacity:0;transform:translateX(100px)}}
.toast-icon{width:40px;height:40px;min-width:40px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:18px}
.toast-success .toast-icon{background:rgba(22,163,74,.1);color:var(--success)}
.toast-error .toast-icon{background:rgba(239,68,68,.1);color:var(--error)}
.toast-content{flex:1}
.toast-title{font-size:14px;font-weight:700;margin-bottom:2px}
.toast-message{font-size:13px;color:var(--gray)}

@media(max-width:768px){
.dashboard{padding:20px}
.dashboard-header{flex-direction:column;align-items:flex-start}
.stats-grid{grid-template-columns:1fr}
.form-row{grid-template-columns:1fr}
.table-actions{flex-direction:column}
.search-box{width:100%}
.modal-content{padding:24px}
}
</style>
</head>
<body>

<!-- Password Screen -->
<div class="password-screen" id="passwordScreen">
<div class="password-box">
<div class="password-icon"><i class="fas fa-lock"></i></div>
<h2 class="password-title">Área Administrativa</h2>
<p class="password-subtitle">Digite a senha para acessar o painel de analytics</p>
<div class="alert alert-error" id="passwordAlert"></div>
<form id="passwordForm">
<div class="form-group">
<label class="label">Senha de Acesso</label>
<input type="password" class="input" id="passwordInput" placeholder="••••••••" required autocomplete="off">
</div>
<button type="submit" class="btn" id="passwordBtn">
<i class="fas fa-sign-in-alt"></i>Acessar Painel
</button>
</form>
</div>
</div>

<!-- Dashboard -->
<div class="dashboard" id="dashboard">
<div class="dashboard-header">
<h1 class="dashboard-title">Analytics & Gestão</h1>
<div class="dashboard-actions">
<button class="btn-secondary btn-outline" onclick="exportStockToExcel()">
<i class="fas fa-file-excel"></i>Exportar Estoque
</button>
<button class="btn-secondary" onclick="logout()">
<i class="fas fa-sign-out-alt"></i>Sair
</button>
</div>
</div>

<!-- Stats Cards -->
<div class="stats-grid">
<div class="stat-card">
<div class="stat-header">
<div>
<div class="stat-label">Produtos Cadastrados</div>
</div>
<div class="stat-icon icon-primary">
<i class="fas fa-box"></i>
</div>
</div>
<div class="stat-value" id="totalProducts">0</div>
<div class="stat-footer">
<span class="stat-badge" id="availableProducts">0 disponíveis</span>
</div>
</div>

<div class="stat-card">
<div class="stat-header">
<div>
<div class="stat-label">Produtos Vendidos</div>
</div>
<div class="stat-icon icon-success">
<i class="fas fa-check-circle"></i>
</div>
</div>
<div class="stat-value" id="soldProducts">0</div>
<div class="stat-footer">
<i class="fas fa-chart-line"></i>
<span>Total de vendas realizadas</span>
</div>
</div>

<div class="stat-card">
<div class="stat-header">
<div>
<div class="stat-label">Valor em Estoque</div>
</div>
<div class="stat-icon icon-warning">
<i class="fas fa-coins"></i>
</div>
</div>
<div class="stat-value" id="stockValue">R$ 0</div>
<div class="stat-footer">
<i class="fas fa-boxes"></i>
<span>Valor total cadastrado</span>
</div>
</div>

<div class="stat-card">
<div class="stat-header">
<div>
<div class="stat-label">Valor Vendido</div>
</div>
<div class="stat-icon icon-success">
<i class="fas fa-dollar-sign"></i>
</div>
</div>
<div class="stat-value" id="soldValue">R$ 0</div>
<div class="stat-footer">
<i class="fas fa-money-bill-wave"></i>
<span>Receita total gerada</span>
</div>
</div>
</div>

<!-- Products Table -->
<div class="table-section">
<div class="section-header">
<h2 class="section-title">Gerenciamento de Produtos</h2>
<div class="table-actions">
<div class="search-box">
<i class="fas fa-search search-icon"></i>
<input type="text" class="search-input" id="productSearch" placeholder="Buscar por código ou nome...">
</div>
<button class="btn-secondary btn-small" onclick="openProductModal()">
<i class="fas fa-plus"></i>Novo Produto
</button>
</div>
</div>
<div class="table-container">
<table class="table">
<thead>
<tr>
<th>Imagem</th>
<th>Código</th>
<th>Nome</th>
<th>Categoria</th>
<th>Preço</th>
<th>Status</th>
<th>Ações</th>
</tr>
</thead>
<tbody id="productsTableBody">
<tr><td colspan="7" class="loading"><span class="spinner"></span>Carregando produtos...</td></tr>
</tbody>
</table>
</div>
</div>

<!-- Sales Control -->
<div class="table-section">
<div class="section-header">
<h2 class="section-title">Controle de Vendas & Serviços</h2>
<div class="table-actions">
<div class="sales-filters">
<select class="filter-select" id="salesMonthFilter">
<option value="">Todos os meses</option>
<option value="01">Janeiro</option>
<option value="02">Fevereiro</option>
<option value="03">Março</option>
<option value="04">Abril</option>
<option value="05">Maio</option>
<option value="06">Junho</option>
<option value="07">Julho</option>
<option value="08">Agosto</option>
<option value="09">Setembro</option>
<option value="10">Outubro</option>
<option value="11">Novembro</option>
<option value="12">Dezembro</option>
</select>
<select class="filter-select" id="salesYearFilter">
<option value="">Todos os anos</option>
</select>
</div>
<button class="btn-secondary btn-small" onclick="exportSalesToExcel()">
<i class="fas fa-file-excel"></i>Exportar Período
</button>
<button class="btn-secondary btn-small" onclick="openSaleModal()">
<i class="fas fa-plus"></i>Nova Venda/Serviço
</button>
</div>
</div>
<div class="table-container">
<table class="table">
<thead>
<tr>
<th>Data/Hora</th>
<th>Tipo</th>
<th>Descrição</th>
<th>Valor</th>
<th>Ações</th>
</tr>
</thead>
<tbody id="salesTableBody">
<tr><td colspan="5" class="loading"><span class="spinner"></span>Carregando vendas...</td></tr>
</tbody>
</table>
</div>
</div>
</div>

<!-- Product Modal -->
<div class="modal" id="productModal">
<div class="modal-box">
<div class="modal-header">
<h3 class="modal-title" id="productModalTitle">Novo Produto</h3>
<button class="modal-close" onclick="closeProductModal()"><i class="fas fa-times"></i></button>
</div>
<div class="modal-content">
<form id="productForm">
<input type="hidden" id="productId">
<div class="form-row">
<div class="form-group">
<label class="label">Código</label>
<input type="text" class="input" id="productCode" required>
</div>
<div class="form-group">
<label class="label">Nome</label>
<input type="text" class="input" id="productName" required>
</div>
</div>
<div class="form-row">
<div class="form-group">
<label class="label">Categoria</label>
<input type="text" class="input" id="productCategory">
</div>
<div class="form-group">
<label class="label">Status</label>
<select class="select" id="productStatus" required>
<option value="available">Disponível</option>
<option value="waiting">Em Espera</option>
<option value="sold">Vendido</option>
</select>
</div>
</div>
<div class="form-row">
<div class="form-group">
<label class="label">Preço (R$)</label>
<input type="number" class="input" id="productPrice" step="0.01" required>
</div>
<div class="form-group">
<label class="label">Preço com Desconto (R$)</label>
<input type="number" class="input" id="productDiscount" step="0.01">
</div>
</div>
<div class="form-row">
<div class="form-group">
<label class="label">Tamanho</label>
<input type="text" class="input" id="productSize">
</div>
<div class="form-group">
<label class="label">Material</label>
<input type="text" class="input" id="productMaterial">
</div>
</div>
<div class="form-group form-group-full">
<label class="label">Descrição</label>
<textarea class="input textarea" id="productDescription"></textarea>
</div>
<div class="form-group form-group-full">
<label class="label">URLs das Imagens (uma por linha)</label>
<textarea class="input textarea" id="productImages" placeholder="https://exemplo.com/imagem1.jpg
https://exemplo.com/imagem2.jpg"></textarea>
<div class="image-preview" id="imagePreview"></div>
</div>
</form>
</div>
<div class="modal-footer">
<button class="btn-secondary btn-outline" onclick="closeProductModal()">Cancelar</button>
<button class="btn-secondary" onclick="saveProduct()">
<i class="fas fa-save"></i>Salvar Produto
</button>
</div>
</div>
</div>

<!-- Sale Modal -->
<div class="modal" id="saleModal">
<div class="modal-box">
<div class="modal-header">
<h3 class="modal-title">Nova Venda/Serviço</h3>
<button class="modal-close" onclick="closeSaleModal()"><i class="fas fa-times"></i></button>
</div>
<div class="modal-content">
<form id="saleForm">
<div class="form-group">
<label class="label">Tipo</label>
<select class="select" id="saleType" required>
<option value="venda">Venda de Produto</option>
<option value="costura">Serviço de Costura</option>
<option value="outros">Outros</option>
</select>
</div>
<div class="form-group">
<label class="label">Descrição</label>
<textarea class="input textarea" id="saleDescription" required placeholder="Descreva o produto vendido ou serviço realizado..."></textarea>
</div>
<div class="form-group">
<label class="label">Valor (R$)</label>
<input type="number" class="input" id="saleValue" step="0.01" required>
</div>
</form>
</div>
<div class="modal-footer">
<button class="btn-secondary btn-outline" onclick="closeSaleModal()">Cancelar</button>
<button class="btn-secondary" onclick="saveSale()">
<i class="fas fa-save"></i>Registrar
</button>
</div>
</div>
</div>

<!-- Toast Container -->
<div class="toast-container" id="toastContainer"></div>

<script type="module">
import{initializeApp}from'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
import{getFirestore,collection,getDocs,doc,getDoc,setDoc,updateDoc,deleteDoc,query,where,orderBy}from'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
import{getAuth,onAuthStateChanged}from'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';

const app=initializeApp({apiKey:"AIzaSyCLJ5jo4JknJAe9OlH10EawYEvqjJGnvKg",authDomain:"myfrancashop.firebaseapp.com",projectId:"myfrancashop",storageBucket:"myfrancashop.firebasestorage.app",messagingSenderId:"935759870053",appId:"1:935759870053:web:aabe4af138691d021bee8c"});

const db=getFirestore(app);
const auth=getAuth(app);

const PASSWORD='admin123';
const SESSION_TIMEOUT=60000;
let sessionTimer;
let allProducts=[];
let allSales=[];
let currentUser=null;

// Toast System
function showToast(message,type='success'){
const container=document.getElementById('toastContainer');
const toast=document.createElement('div');
toast.className=`toast toast-${type}`;
const iconClass=type==='success'?'fa-circle-check':'fa-circle-exclamation';
const title=type==='success'?'Sucesso':'Erro';
toast.innerHTML=`
<div class="toast-icon"><i class="fas ${iconClass}"></i></div>
<div class="toast-content">
<div class="toast-title">${title}</div>
<div class="toast-message">${message}</div>
</div>
`;
container.appendChild(toast);
setTimeout(()=>{
toast.classList.add('removing');
setTimeout(()=>toast.remove(),300);
},3000);
}

// Session Management
function startSessionTimer(){
clearTimeout(sessionTimer);
sessionTimer=setTimeout(()=>{
logout();
showToast('Sessão expirada por inatividade','error');
},SESSION_TIMEOUT);
}

function resetSessionTimer(){
startSessionTimer();
}

document.addEventListener('mousemove',resetSessionTimer);
document.addEventListener('keypress',resetSessionTimer);
document.addEventListener('click',resetSessionTimer);

// Password Authentication
document.getElementById('passwordForm').addEventListener('submit',(e)=>{
e.preventDefault();
const password=document.getElementById('passwordInput').value;
const alert=document.getElementById('passwordAlert');

if(password===PASSWORD){
sessionStorage.setItem('analyticsAuth','true');
document.getElementById('passwordScreen').style.display='none';
document.getElementById('dashboard').classList.add('active');
startSessionTimer();
loadDashboard();
}else{
alert.textContent='Senha incorreta. Tente novamente.';
alert.classList.add('show');
setTimeout(()=>alert.classList.remove('show'),3000);
}
});

window.logout=()=>{
sessionStorage.removeItem('analyticsAuth');
clearTimeout(sessionTimer);
document.getElementById('passwordScreen').style.display='flex';
document.getElementById('dashboard').classList.remove('active');
document.getElementById('passwordInput').value='';
};

// Check Authentication
onAuthStateChanged(auth,async(user)=>{
if(!user){
window.location.href='login.html';
return;
}

currentUser=user;
try{
const adminDoc=await getDoc(doc(db,'admins',user.uid));
if(!adminDoc.exists()){
window.location.href='error.html';
return;
}

const isAuth=sessionStorage.getItem('analyticsAuth');
if(isAuth==='true'){
document.getElementById('passwordScreen').style.display='none';
document.getElementById('dashboard').classList.add('active');
startSessionTimer();
loadDashboard();
}
}catch(e){
console.error('Erro:',e);
window.location.href='error.html';
}
});

// Load Dashboard Data
async function loadDashboard(){
await loadProducts();
await loadSales();
calculateStats();
populateYearFilter();
}

// Calculate Statistics
function calculateStats(){
const available=allProducts.filter(p=>p.status==='available').length;
const sold=allProducts.filter(p=>p.status==='sold').length;

const stockValue=allProducts
.filter(p=>p.status!=='sold')
.reduce((sum,p)=>{
const price=parseFloat(p.discountPrice)||parseFloat(p.price)||0;
return sum+price;
},0);

const soldValue=allSales.reduce((sum,s)=>sum+(parseFloat(s.value)||0),0);

document.getElementById('totalProducts').textContent=allProducts.length;
document.getElementById('soldProducts').textContent=sold;
document.getElementById('availableProducts').textContent=`${available} disponíveis`;
document.getElementById('stockValue').textContent=formatPrice(stockValue);
document.getElementById('soldValue').textContent=formatPrice(soldValue);
}

// Load Products
async function loadProducts(){
try{
const snap=await getDocs(collection(db,'products'));
allProducts=[];
snap.forEach(doc=>{
allProducts.push({id:doc.id,...doc.data()});
});
renderProductsTable();
}catch(e){
console.error('Erro:',e);
showToast('Erro ao carregar produtos','error');
}
}

function renderProductsTable(searchTerm=''){
const tbody=document.getElementById('productsTableBody');
let filtered=allProducts;

if(searchTerm){
const term=searchTerm.toLowerCase();
filtered=allProducts.filter(p=>
(p.code||'').toLowerCase().includes(term)||
(p.name||'').toLowerCase().includes(term)
);
}

if(filtered.length===0){
tbody.innerHTML='<tr><td colspan="7" style="text-align:center;padding:40px;color:#666">Nenhum produto encontrado</td></tr>';
return;
}

tbody.innerHTML=filtered.map(p=>{
const statusClass=p.status==='available'?'status-available':p.status==='waiting'?'status-waiting':'status-sold';
const statusText=p.status==='available'?'Disponível':p.status==='waiting'?'Em Espera':'Vendido';
const img=p.images&&p.images[0]?`<img src="${p.images[0]}" class="table-img" alt="${p.name}">`:'<div class="table-img" style="background:#f5f5f5;display:flex;align-items:center;justify-content:center;color:#999"><i class="fas fa-image"></i></div>';
const price=parseFloat(p.discountPrice)||parseFloat(p.price)||0;

return`
<tr>
<td>${img}</td>
<td><strong>${p.code||'---'}</strong></td>
<td>${p.name||'Sem nome'}</td>
<td>${p.category||'---'}</td>
<td class="price-cell">${formatPrice(price)}</td>
<td><span class="status-badge ${statusClass}">${statusText}</span></td>
<td>
<div class="table-actions-cell">
<button class="icon-btn" onclick="editProduct('${p.id}')" title="Editar">
<i class="fas fa-edit"></i>
</button>
<button class="icon-btn" onclick="deleteProduct('${p.id}')" title="Excluir">
<i class="fas fa-trash"></i>
</button>
</div>
</td>
</tr>
`;
}).join('');
}

document.getElementById('productSearch').addEventListener('input',(e)=>{
renderProductsTable(e.target.value);
});

// Product CRUD
window.openProductModal=()=>{
document.getElementById('productModalTitle').textContent='Novo Produto';
document.getElementById('productForm').reset();
document.getElementById('productId').value='';
document.getElementById('imagePreview').innerHTML='';
document.getElementById('productModal').classList.add('active');
};

window.closeProductModal=()=>{
document.getElementById('productModal').classList.remove('active');
};

window.editProduct=async(id)=>{
const product=allProducts.find(p=>p.id===id);
if(!product)return;

document.getElementById('productModalTitle').textContent='Editar Produto';
document.getElementById('productId').value=id;
document.getElementById('productCode').value=product.code||'';
document.getElementById('productName').value=product.name||'';
document.getElementById('productCategory').value=product.category||'';
document.getElementById('productStatus').value=product.status||'available';
document.getElementById('productPrice').value=product.price||'';
document.getElementById('productDiscount').value=product.discountPrice||'';
document.getElementById('productSize').value=product.size||'';
document.getElementById('productMaterial').value=product.material||'';
document.getElementById('productDescription').value=product.description||'';
document.getElementById('productImages').value=(product.images||[]).join('\n');
document.getElementById('productModal').classList.add('active');
};

window.saveProduct=async()=>{
const id=document.getElementById('productId').value;
const code=document.getElementById('productCode').value.trim();
const name=document.getElementById('productName').value.trim();
const category=document.getElementById('productCategory').value.trim();
const status=document.getElementById('productStatus').value;
const price=document.getElementById('productPrice').value;
const discountPrice=document.getElementById('productDiscount').value;
const size=document.getElementById('productSize').value.trim();
const material=document.getElementById('productMaterial').value.trim();
const description=document.getElementById('productDescription').value.trim();
const imagesText=document.getElementById('productImages').value.trim();
const images=imagesText?imagesText.split('\n').map(url=>url.trim()).filter(url=>url):[]:

if(!code||!name||!price){
showToast('Preencha os campos obrigatórios','error');
return;
}

try{
const productData={
code,
name,
category,
status,
price:parseFloat(price),
discountPrice:discountPrice?parseFloat(discountPrice):null,
size,
material,
description,
images,
updatedAt:new Date()
};

if(id){
await updateDoc(doc(db,'products',id),productData);
showToast('Produto atualizado com sucesso!');
}else{
productData.createdAt=new Date();
const newDoc=doc(collection(db,'products'));
await setDoc(newDoc,productData);
showToast('Produto criado com sucesso!');
}

closeProductModal();
await loadProducts();
calculateStats();
}catch(e){
console.error('Erro:',e);
showToast('Erro ao salvar produto','error');
}
};

window.deleteProduct=async(id)=>{
if(!confirm('Tem certeza que deseja excluir este produto?'))return;

try{
await deleteDoc(doc(db,'products',id));
showToast('Produto excluído com sucesso!');
await loadProducts();
calculateStats();
}catch(e){
console.error('Erro:',e);
showToast('Erro ao excluir produto','error');
}
};

// Sales Management
async function loadSales(){
try{
const snap=await getDocs(collection(db,'sales'));
allSales=[];
snap.forEach(doc=>{
allSales.push({id:doc.id,...doc.data()});
});
allSales.sort((a,b)=>{
const dateA=a.createdAt?.toDate?.()||new Date(0);
const dateB=b.createdAt?.toDate?.()||new Date(0);
return dateB-dateA;
});
renderSalesTable();
}catch(e){
console.error('Erro:',e);
showToast('Erro ao carregar vendas','error');
}
}

function renderSalesTable(){
const tbody=document.getElementById('salesTableBody');
const monthFilter=document.getElementById('salesMonthFilter').value;
const yearFilter=document.getElementById('salesYearFilter').value;

let filtered=allSales;

if(monthFilter||yearFilter){
filtered=allSales.filter(s=>{
const date=s.createdAt?.toDate?.()||new Date();
const match=(!monthFilter||date.getMonth()===parseInt(monthFilter)-1)&&
(!yearFilter||date.getFullYear()===parseInt(yearFilter));
return match;
});
}

if(filtered.length===0){
tbody.innerHTML='<tr><td colspan="5" style="text-align:center;padding:40px;color:#666">Nenhuma venda registrada</td></tr>';
return;
}

tbody.innerHTML=filtered.map(s=>{
const date=s.createdAt?.toDate?.()||new Date();
const dateStr=date.toLocaleString('pt-BR',{
day:'2-digit',
month:'2-digit',
year:'numeric',
hour:'2-digit',
minute:'2-digit'
});
const typeText=s.type==='venda'?'Venda':s.type==='costura'?'Costura':'Outros';

return`
<tr>
<td><strong>${dateStr}</strong></td>
<td><span class="status-badge status-available">${typeText}</span></td>
<td>${s.description||'---'}</td>
<td class="price-cell">${formatPrice(s.value)}</td>
<td>
<button class="icon-btn" onclick="deleteSale('${s.id}')" title="Excluir">
<i class="fas fa-trash"></i>
</button>
</td>
</tr>
`;
}).join('');
}

document.getElementById('salesMonthFilter').addEventListener('change',renderSalesTable);
document.getElementById('salesYearFilter').addEventListener('change',renderSalesTable);

function populateYearFilter(){
const select=document.getElementById('salesYearFilter');
const years=new Set();
allSales.forEach(s=>{
const date=s.createdAt?.toDate?.()||new Date();
years.add(date.getFullYear());
});
const sortedYears=Array.from(years).sort((a,b)=>b-a);
select.innerHTML='<option value="">Todos os anos</option>'+
sortedYears.map(y=>`<option value="${y}">${y}</option>`).join('');
}

window.openSaleModal=()=>{
document.getElementById('saleForm').reset();
document.getElementById('saleModal').classList.add('active');
};

window.closeSaleModal=()=>{
document.getElementById('saleModal').classList.remove('active');
};

window.saveSale=async()=>{
const type=document.getElementById('saleType').value;
const description=document.getElementById('saleDescription').value.trim();
const value=document.getElementById('saleValue').value;

if(!type||!description||!value){
showToast('Preencha todos os campos','error');
return;
}

try{
const saleData={
type,
description,
value:parseFloat(value),
createdAt:new Date()
};

const newDoc=doc(collection(db,'sales'));
await setDoc(newDoc,saleData);
showToast('Venda registrada com sucesso!');
closeSaleModal();
await loadSales();
calculateStats();
}catch(e){
console.error('Erro:',e);
showToast('Erro ao registrar venda','error');
}
};

window.deleteSale=async(id)=>{
if(!confirm('Tem certeza que deseja excluir este registro?'))return;

try{
await deleteDoc(doc(db,'sales',id));
showToast('Registro excluído com sucesso!');
await loadSales();
calculateStats();
}catch(e){
console.error('Erro:',e);
showToast('Erro ao excluir registro','error');
}
};

// Export Functions
window.exportStockToExcel=()=>{
const data=[['Código','Nome','Categoria','Status','Preço','Desconto','Tamanho','Material','Descrição']];
allProducts.forEach(p=>{
data.push([
p.code||'',
p.name||'',
p.category||'',
p.status||'',
p.price||'',
p.discountPrice||'',
p.size||'',
p.material||'',
p.description||''
]);
});
exportToExcel(data,'Estoque_ColorShop');
};

window.exportSalesToExcel=()=>{
const monthFilter=document.getElementById('salesMonthFilter').value;
const yearFilter=document.getElementById('salesYearFilter').value;

let filtered=allSales;
if(monthFilter||yearFilter){
filtered=allSales.filter(s=>{
const date=s.createdAt?.toDate?.()||new Date();
return(!monthFilter||date.getMonth()===parseInt(monthFilter)-1)&&
(!yearFilter||date.getFullYear()===parseInt(yearFilter));
});
}

const data=[['Data/Hora','Tipo','Descrição','Valor']];
filtered.forEach(s=>{
const date=s.createdAt?.toDate?.()||new Date();
const dateStr=date.toLocaleString('pt-BR');
const typeText=s.type==='venda'?'Venda':s.type==='costura'?'Costura':'Outros';
data.push([dateStr,typeText,s.description||'',s.value||'']);
});

const fileName=`Vendas_${yearFilter||'Todas'}${monthFilter?'_'+monthFilter:''}`;
exportToExcel(data,fileName);
};

function exportToExcel(data,fileName){
let csv='';
data.forEach(row=>{
csv+=row.map(cell=>`"${cell}"`).join(',')+'\n';
});

const blob=new Blob(['\uFEFF'+csv],{type:'text/csv;charset=utf-8;'});
const link=document.createElement('a');
link.href=URL.createObjectURL(blob);
link.download=fileName+'.csv';
link.click();
showToast('Arquivo exportado com sucesso!');
}

function formatPrice(p){
if(!p||isNaN(p))return'R$ 0,00';
return`R$ ${parseFloat(p).toFixed(2).replace('.',',')}`;
}

console.log('Analytics System Loaded')
</script>
</body>
</html>